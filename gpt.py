import os
import openai
import json
from dotenv import load_dotenv
from datetime import datetime, timedelta
import re

# ğŸ” í™˜ê²½ë³€ìˆ˜ ë¡œë“œ
load_dotenv()
client = openai.OpenAI(api_key=os.getenv("OPENAI_API_KEY"))

def get_next_weekday(current_date: datetime, target_weekday: int) -> datetime:
    """ì£¼ì–´ì§„ ë‚ ì§œì˜ ë‹¤ìŒ íŠ¹ì • ìš”ì¼ ë‚ ì§œë¥¼ ë°˜í™˜"""
    days_ahead = target_weekday - current_date.weekday()
    if days_ahead <= 0:  # Target day already happened this week
        days_ahead += 7
    return current_date + timedelta(days=days_ahead)

def extract_base_date(dialogue_texts: list[str]) -> datetime:
    """ëŒ€í™”ì—ì„œ ì²« ë©”ì‹œì§€ì˜ ë‚ ì§œë¥¼ ì¶”ì¶œ"""
    if not dialogue_texts:
        return datetime.now()
    
    # [YYYY-MM-DD HH:mm] í˜•ì‹ì˜ ë‚ ì§œ ì°¾ê¸°
    date_pattern = r'\[(\d{4}-\d{2}-\d{2})\s+[^\]]+\]'
    for text in dialogue_texts:
        match = re.search(date_pattern, text)
        if match:
            try:
                return datetime.strptime(match.group(1), '%Y-%m-%d')
            except ValueError:
                pass
    return datetime.now()

def analyze_dialogue(dialogue_texts: list[str], base_date: datetime = None, model_name: str = "gpt-4") -> dict:
    # ëŒ€í™”ì—ì„œ ë‚ ì§œ ì¶”ì¶œ ë˜ëŠ” ì£¼ì–´ì§„ base_date ì‚¬ìš©
    today = base_date if base_date else extract_base_date(dialogue_texts)
    
    # ëŒ€í™”ì—ì„œ ë‚ ì§œ/ì‹œê°„ ì •ë³´ë§Œ ì¶”ì¶œ
    cleaned_texts = []
    for text in dialogue_texts:
        # ë‚ ì§œ ë¶€ë¶„ ì œê±°
        cleaned_text = re.sub(r'\[\d{4}-\d{2}-\d{2}\s+[^\]]+\]\s*', '', text)
        cleaned_texts.append(cleaned_text)
    
    prompt = (
        f"ì˜¤ëŠ˜ì€ {today.year}ë…„ {today.month}ì›” {today.day}ì¼ì…ë‹ˆë‹¤.\n"
        "ì•„ë˜ ëŒ€í™”ë¥¼ ë¶„ì„í•˜ì—¬ ì•½ì† ì‹œê°„ê³¼ ì¥ì†Œë¥¼ ì°¾ì•„ì£¼ì„¸ìš”.\n\n"
        "ì£¼ì˜ì‚¬í•­:\n"
        "1. ë°˜ë“œì‹œ JSON í˜•ì‹ìœ¼ë¡œë§Œ ì‘ë‹µí•˜ì„¸ìš”.\n"
        "2. ë‹¤ë¥¸ ì„¤ëª…ì´ë‚˜ í…ìŠ¤íŠ¸ëŠ” ì ˆëŒ€ í¬í•¨í•˜ì§€ ë§ˆì„¸ìš”.\n"
        "3. ìµœëŒ€í•œ ë§ì€ ì°¸ì—¬ìê°€ ê°€ëŠ¥í•œ ì‹œê°„ì„ ì°¾ì•„ë‚´ì„¸ìš”.\n"
        "4. ì‹œê°„ì´ êµ¬ì²´ì ìœ¼ë¡œ ì–¸ê¸‰ë˜ì§€ ì•Šì€ ê²½ìš°ì—ë§Œ ì˜¤í›„ 5ì‹œ(17:00)ë¥¼ ì‚¬ìš©í•˜ì„¸ìš”.\n"
        "5. ë‚ ì§œëŠ” ë°˜ë“œì‹œ 'YYYYë…„ MMì›” DDì¼ ìš”ì¼ HH:MM' í˜•ì‹ìœ¼ë¡œ ë°˜í™˜í•˜ì„¸ìš”.\n"
        "6. ëŒ€í™”ì—ì„œ ì–¸ê¸‰ëœ êµ¬ì²´ì ì¸ ì‹œê°„ì´ ìˆë‹¤ë©´ ë°˜ë“œì‹œ ê·¸ ì‹œê°„ì„ ì‚¬ìš©í•˜ì„¸ìš”.\n"
        "7. ì˜ë¯¸ ì—†ëŠ” ëŒ€í™”ë‚˜ ë¬´ê´€í•œ ë°œì–¸ì€ ë¬´ì‹œí•˜ì„¸ìš”.\n"
        "8. ì‹œê°„ì„ ì „í˜€ ì–¸ê¸‰í•˜ì§€ ì•Šì€ ì°¸ì—¬ìëŠ” ë¶„ì„ì—ì„œ ì œì™¸í•˜ì„¸ìš”.\n"
        "9. 'ë‹¤ìŒì£¼'ëŠ” ë°˜ë“œì‹œ ëŒ€í™” ë‚ ì§œ ê¸°ì¤€ìœ¼ë¡œ ê³„ì‚°í•˜ì„¸ìš”.\n\n"
        
        "ì‹œê°„ ë¶„ì„ ê·œì¹™:\n"
        "1. ìš”ì¼ ê¸°ë°˜ ë¶„ì„:\n"
        "- ê° ì°¸ì—¬ìê°€ ì–¸ê¸‰í•œ ê°€ëŠ¥í•œ ìš”ì¼ë“¤ì„ ëª¨ë‘ íŒŒì•…\n"
        "- ë¶ˆê°€ëŠ¥í•œ ìš”ì¼ í‘œí˜„ë„ ë°˜ë“œì‹œ ê³ ë ¤ ('ì›”,í™” ë¹¼ê³ ', 'A ì œì™¸' ë“±)\n"
        "- ì˜ˆì‹œ:\n"
        "  * 'ì›”,í™” ê°€ëŠ¥' â†’ [ì›”,í™”] ê°€ëŠ¥\n"
        "  * 'ì›”,í™” ë¹¼ê³  ë‹¤ ê°€ëŠ¥' â†’ [ìˆ˜,ëª©,ê¸ˆ,í† ,ì¼] ê°€ëŠ¥\n"
        "  * 'ì›”í™”ìˆ˜ ì œì™¸í•˜ê³ ' â†’ [ëª©,ê¸ˆ,í† ,ì¼] ê°€ëŠ¥\n"
        "- ì‹œê°„ì„ ì–¸ê¸‰í•œ ì°¸ì—¬ìë“¤ ì¤‘ ê°€ì¥ ë§ì€ ì‚¬ëŒì´ ê°€ëŠ¥í•œ ìš”ì¼ ì°¾ê¸°\n"
        "- 'ì›”,í™”' ë˜ëŠ” 'ì›”í™”ìˆ˜' ê°™ì€ ì—°ì†ëœ í‘œí˜„ë„ ê°ê°ì˜ ìš”ì¼ë¡œ ë¶„ë¦¬\n\n"
        
        "2. ì‹œê°„ í‘œí˜„:\n"
        "- 'ë‹¤ìŒ ì£¼' â†’ ëŒ€í™” ë‚ ì§œ({today.strftime('%Y-%m-%d')}) ê¸°ì¤€ ë‹¤ìŒ ì£¼ì˜ ë‚ ì§œ\n"
        "- 'ë‹¤ë‹¤ìŒ ì£¼' â†’ ëŒ€í™” ë‚ ì§œ ê¸°ì¤€ 2ì£¼ í›„ì˜ ì£¼\n"
        "- 'ì´ë²ˆ ì£¼' â†’ ëŒ€í™” ë‚ ì§œê°€ ì†í•œ ì£¼ê°„\n"
        "- 'Nì£¼ ë’¤' â†’ Nì£¼ í›„\n"
        "- 'ë‚´ì¼' â†’ ëŒ€í™” ë‚ ì§œ ë‹¤ìŒ ë‚ \n"
        "- '8ì›” ë‘˜ì§¸ ì£¼' â†’ 8ì›” ë‘ ë²ˆì§¸ ì£¼ ì‹œì‘ì¼ ê¸°ì¤€\n\n"
        
        "3. ì‹œê°„ëŒ€ ë³€í™˜:\n"
        "- 'Nì‹œ' â†’ HH:00 í˜•ì‹ìœ¼ë¡œ ë³€í™˜\n"
        "- 'Nì‹œ ë°˜' â†’ HH:30 í˜•ì‹ìœ¼ë¡œ ë³€í™˜\n"
        "- 'ì˜¤ì „' = 10:00\n"
        "- 'ì ì‹¬' = 12:00\n"
        "- 'ì˜¤í›„' = 17:00\n"
        "- 'ì €ë…' = 18:00\n"
        "- '6ì‹œ ë°˜' = 18:30\n"
        "- '7ì‹œ' = 19:00\n\n"
        
        "4. ê°€ëŠ¥ ì‹œê°„ ë¶„ì„ ë°©ë²•:\n"
        "- ê° ì°¸ì—¬ìì˜ ê°€ëŠ¥í•œ ìš”ì¼ì„ ë¦¬ìŠ¤íŠ¸ë¡œ ë§Œë“¤ê¸°\n"
        "- ë¶ˆê°€ëŠ¥í•˜ë‹¤ê³  ì–¸ê¸‰ëœ ìš”ì¼ì€ ë°˜ë“œì‹œ ì œì™¸\n"
        "- ì‹œê°„ì„ ì–¸ê¸‰í•œ ì°¸ì—¬ìë“¤ ì¤‘ ê°€ì¥ ë§ì€ ì‚¬ëŒì´ ê°€ëŠ¥í•œ ìš”ì¼ ì°¾ê¸°\n"
        "- ì‹œê°„ì„ ì „í˜€ ì–¸ê¸‰í•˜ì§€ ì•Šì€ ì°¸ì—¬ìëŠ” ë¶„ì„ì—ì„œ ì œì™¸\n"
        "- ë¬´ì˜ë¯¸í•œ ëŒ€í™”ë‚˜ ê´€ë ¨ ì—†ëŠ” ë°œì–¸ì€ ë¬´ì‹œ\n"
        "- ì˜ˆì‹œ:\n"
        "  * 'ê¸ˆìš”ì¼ 6ì‹œ ë°˜ìœ¼ë¡œ í• ê¹Œìš”?' â†’ 'ê¸ˆìš”ì¼ 18:30'\n"
        "  * 'ì‹ ì´Œ 6ì‹œ ë°˜ìœ¼ë¡œ í™•ì •í•˜ì!' â†’ 'ê¸ˆìš”ì¼ 18:30'\n\n"
        
        "5. ì¥ì†Œ ë¶„ì„:\n"
        "- ê¸ì •ì  í‘œí˜„: 'ì¢‹ë‹¤', 'ê´œì°®ë‹¤', 'ì¢‹ì•„', 'ê°€ì' ë“±\n"
        "- ë¶€ì •ì  í‘œí˜„: 'ì‹«ë‹¤', 'ë³„ë¡œ', 'ê·¹í˜', 'ì—­ê²¨ì›Œ', 'ì•ˆë³¼ë˜', 'ì •ì‹ ì—†ì–´' ë“±\n"
        "- ë¬´ì˜ë¯¸í•œ ë°œì–¸ì´ë‚˜ ê´€ë ¨ ì—†ëŠ” ëŒ€í™”ëŠ” ë¬´ì‹œ\n\n"
        
        "6. ì‹œê°„ ì •ë³´ ë¶€ì¡± íŒë‹¨:\n"
        "- ì‹œê°„ì„ ì–¸ê¸‰í•œ ì°¸ì—¬ìê°€ 2ëª… ë¯¸ë§Œì¸ ê²½ìš°\n"
        "- ì‹œê°„ì„ ì–¸ê¸‰í•œ ì°¸ì—¬ìë“¤ ê°„ì— ê²¹ì¹˜ëŠ” ì‹œê°„ì´ ì „í˜€ ì—†ëŠ” ê²½ìš°\n"
        "- ì‹œê°„ ì •ë³´ê°€ ë¶€ì¡±í•˜ë‹¤ê³  íŒë‹¨ë˜ë©´ available_timesë¥¼ ë¹ˆ ë°°ì—´ë¡œ ë°˜í™˜\n\n"
        
        "7. ì°¸ì—¬ì ë¶„ì„:\n"
        "- ì‹œê°„ ê´€ë ¨ ë°œì–¸ì„ í•œ ì°¸ì—¬ìë§Œ ë¶„ì„ì— í¬í•¨\n"
        "- ì¥ì†Œë§Œ ì–¸ê¸‰í•˜ê±°ë‚˜ ë¬´ì˜ë¯¸í•œ ëŒ€í™”ë§Œ í•œ ì°¸ì—¬ìëŠ” ì œì™¸\n"
        "- ì˜ˆì‹œ:\n"
        "  * 'í‰í‰í‰' â†’ ë¬´ì‹œ\n"
        "  * 'íŠ¸ë„ë¼ë ˆë¡œ' â†’ ë¬´ì‹œ\n"
        "  * 'ì¥ì†ŒëŠ” ì–´ë””ê°€ ì¢‹ì„ê¹Œìš”?' â†’ ì‹œê°„ ë¶„ì„ì—ì„œ ì œì™¸\n\n"
        
        "ì•„ë˜ í˜•ì‹ì˜ JSONìœ¼ë¡œë§Œ ì‘ë‹µí•˜ì„¸ìš”:\n"
        "{\n"
        "  \"available_times\": [\"2025ë…„ 6ì›” 13ì¼ ê¸ˆìš”ì¼ 18:30\"],\n"
        "  \"locations\": [\n"
        "    {\"sentence\": \"ì‹ ì´Œ ì¢‹ë‹¤\", \"location\": \"ì‹ ì´Œ\", \"sentiment\": \"positive\"},\n"
        "    {\"sentence\": \"í™ëŒ€ëŠ” ë„ˆë¬´ ë¶ë²¼ì„œ ì‹«ì–´ìš”\", \"location\": \"í™ëŒ€\", \"sentiment\": \"negative\"}\n"
        "  ]\n"
        "}\n\n"
        "ëŒ€í™” ë‚´ìš©:\n"
    )

    for i, text in enumerate(cleaned_texts, 1):
        prompt += f"{i}. {text}\n"

    try:
        response = client.chat.completions.create(
            model=model_name,
            messages=[
                {"role": "system", "content": "ë„ˆëŠ” JSON ì‘ë‹µ ì „ë¬¸ê°€ì•¼. ì–´ë–¤ ìƒí™©ì—ì„œë„ ë°˜ë“œì‹œ ìˆœìˆ˜í•œ JSON í˜•ì‹ìœ¼ë¡œë§Œ ì‘ë‹µí•´ì•¼ í•˜ë©°, ë‹¤ë¥¸ ì„¤ëª…ì´ë‚˜ í…ìŠ¤íŠ¸ëŠ” ì ˆëŒ€ í¬í•¨í•˜ì§€ ë§ˆ. ë¶„ì„ ê²°ê³¼ëŠ” available_timesì™€ locations í‚¤ë¥¼ ê°€ì§„ JSON ê°ì²´ë¡œë§Œ ë°˜í™˜í•´ì•¼ í•´. ë¬´ì˜ë¯¸í•œ ëŒ€í™”ëŠ” ë¬´ì‹œí•˜ê³ , ì‹œê°„ì„ ì–¸ê¸‰í•œ ì°¸ì—¬ìë“¤ ì¤‘ ê°€ì¥ ë§ì€ ì‚¬ëŒì´ ê°€ëŠ¥í•œ ì‹œê°„ì„ ì°¾ì•„ë‚´ì•¼ í•´."},
                {"role": "user", "content": prompt}
            ],
            temperature=0.1
        )
        output_text = response.choices[0].message.content.strip()
        
        # JSON í˜•ì‹ì´ ì•„ë‹Œ í…ìŠ¤íŠ¸ ì œê±°
        try:
            # JSON ì‹œì‘ ìœ„ì¹˜ ì°¾ê¸°
            json_start = output_text.find('{')
            if json_start != -1:
                # JSON ë ìœ„ì¹˜ ì°¾ê¸°
                json_end = output_text.rfind('}') + 1
                if json_end > json_start:
                    output_text = output_text[json_start:json_end]
            
            result = json.loads(output_text)
            return result
        except json.JSONDecodeError:
            print("âš ï¸ GPT ì‘ë‹µì´ JSON í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤. ì‘ë‹µ ë‚´ìš©:\n", output_text)
            return {"available_times": [], "locations": []}

    except Exception as e:
        print("âŒ GPT API í˜¸ì¶œ ì‹¤íŒ¨:", e)
        return {"available_times": [], "locations": []}
